<!-- static/index.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>FrontWave - Visor</title>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { margin:0; font-family:sans-serif }
    header { background:#333; color:#fff; padding:1rem }
    section.card { margin:1rem; padding:1rem; border:1px solid #ccc; border-radius:8px }
    .row { display:flex; flex-wrap:wrap; gap:0.75rem; align-items:center }
    label { font-size:0.9rem }
    select, input[type="text"], input[type="number"] { padding:0.3rem }
    .muted { color:#555; font-size:0.9em }
    #map { height:420px; margin:1rem 0 }
    .table-wrap { overflow:auto; max-height:260px; border:1px solid #ddd }
    table { border-collapse:collapse; width:100% }
    th, td { border:1px solid #ddd; padding:4px 6px; font-size:12px; white-space:nowrap }
    th { background:#f5f5f5; position:sticky; top:0 }
    .chips { display:flex; flex-wrap:wrap; gap:0.5rem; margin:0.5rem 0 }
    .chip { background:#eee; padding:0.4rem 0.8rem; border-radius:18px }
  </style>
</head>
<body>
  <header>
    <h1>FrontWave Tool</h1>
    <h3>Interpolación y velocidad con resumen estadístico</h3>
    <p class="muted">1) Cargar CSV → 2) Revisar separador y campos → 3) Procesar → 4) Ver mapa y descargas</p>
  </header>

  <section class="card">
    <h2>Paso 1 · Cargar CSV</h2>
    <div class="row">
      <input type="file" id="csvfile" accept=".csv" />
      <label>Separador:
        <select id="sep">
          <option value=";">; (punto y coma)</option>
          <option value=",">, (coma)</option>
          <option value="\\t">tab</option>
          <option value="|">| (barra)</option>
        </select>
      </label>
      <button id="preview">Previsualizar</button>
    </div>
    <div class="row" style="margin-top:.5rem">
      <label>lon: <select id="lon_field"></select></label>
      <label>lat: <select id="lat_field"></select></label>
      <label>date: <select id="date_field"></select></label>
      <label>id: <select id="id_field"></select></label>
      <label>weight: <select id="weight_field"></select></label>
      <label>cases: <select id="case_field"></select></label>
      <label>grid (m): <input type="number" id="grid" value="12000" style="width:7rem"></label>
      <label>cell (m): <input type="number" id="cell" value="1200" style="width:7rem"></label>
      <label>contour: <input type="number" id="contour" value="30" style="width:6rem"></label>
      <button id="process">Procesar</button>
    </div>
    <div class="table-wrap" id="preview-wrap" style="display:none">
      <table id="preview-table"></table>
    </div>
    <div class="chips" id="preview-info" style="display:none"></div>
  </section>

  <section class="card">
    <h2>Paso 2 · Mapa</h2>
    <div id="map"></div>
  </section>

  <section class="card">
    <h2>Paso 3 · Descargas</h2>
    <ul id="downloads"></ul>
  </section>

  <section class="card" id="stats-card" style="display:none">
    <h2>Paso 4 · Resumen de velocidad</h2>
    <div class="chips">
      <div class="chip">N: <span id="vel-n">—</span></div>
      <div class="chip">mean: <span id="vel-mean">—</span></div>
      <div class="chip">min: <span id="vel-min">—</span></div>
      <div class="chip">max: <span id="vel-max">—</span></div>
      <div class="chip">std: <span id="vel-std">—</span></div>
      <div class="chip">95% CI: <span id="vel-ci">—</span></div>
    </div>
    <pre id="other-stats" class="muted" style="white-space:pre-wrap">—</pre>
  </section>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Librerías locales para evitar MIME nosniff -->
  <script src="/static/libs/geotiff.min.js"></script>
  <script src="/static/libs/georaster.min.js"></script>
  <script src="/static/libs/georaster-layer-for-leaflet.min.js"></script>

  <!-- PapaParse local o CDN (MIME correcto en jsDelivr suele ir bien; si prefieres, ponlo en /static/libs también) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Verificación de dependencias
    if (typeof parseGeoraster === "undefined") {
      alert("Error cargando georaster*. Usa los .js locales en /static/libs.");
    }

    // --- mapa ---
    const map = L.map("map").setView([40, -3], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {attribution:"© OSM"}).addTo(map);
    const overlays = {};
    const layerControl = L.control.layers(null, overlays).addTo(map);
    let rasterLayers = [];
    let vectorLayers = [];

    function fmt(x, d=3){ return (x==null || isNaN(x)) ? "—" : Number(x).toFixed(d); }
    function fmi(x){ return (x==null || isNaN(x)) ? "—" : String(Math.trunc(x)); }

    function renderVelocitySummary(stats){
      if(!stats || !Number.isFinite(stats.count)){ document.getElementById("stats-card").style.display="none"; return; }
      document.getElementById("stats-card").style.display="";
      document.getElementById("vel-n").textContent = fmi(stats.count);
      document.getElementById("vel-mean").textContent = fmt(stats.mean);
      document.getElementById("vel-min").textContent = fmt(stats.min);
      document.getElementById("vel-max").textContent = fmt(stats.max);
      document.getElementById("vel-std").textContent = fmt(stats.std);
      const ci = (stats.ci95_low!=null && stats.ci95_high!=null) ? `${fmt(stats.ci95_low)}–${fmt(stats.ci95_high)}` : "—";
      document.getElementById("vel-ci").textContent = ci;
      document.getElementById("other-stats").textContent = JSON.stringify(stats, null, 2);
    }

    function clearRasters(){ rasterLayers.forEach(l=>{try{layerControl.removeLayer(l); map.removeLayer(l);}catch{}}); rasterLayers=[]; }
    function clearVectors(){ vectorLayers.forEach(l=>{try{layerControl.removeLayer(l); map.removeLayer(l);}catch{}}); vectorLayers=[]; }

    async function addRaster(name, url){
      try{
        const ab = await fetch(url).then(r=>r.arrayBuffer());
        const georaster = await parseGeoraster(ab);
        const stats = georaster.statistics?.[0] || {};
        const min = Number.isFinite(stats.min) ? stats.min : (georaster.mins?.[0] ?? 0);
        const max = Number.isFinite(stats.max) ? stats.max : (georaster.maxs?.[0] ?? 1);
        const layer = new GeoRasterLayer({
          georaster, opacity:0.75, resolution:256,
          pixelValuesToColorFn: values => {
            const v = values[0]; if (v==null || Number.isNaN(v)) return null;
            const t = (max-min) ? Math.min(1, Math.max(0, (v-min)/(max-min))) : 0.5;
            const g = Math.round(255*t); return `rgb(${g},${g},${g})`;
          }
        }).addTo(map);
        rasterLayers.push(layer);
        overlays[name]=layer; layerControl.addOverlay(layer, name);
        try{ map.fitBounds(layer.getBounds()); }catch{}
      }catch(e){
        console.error("addRaster error", name, e);
        alert(`No se pudo cargar el raster ${name}.`);
      }
    }

    async function addPoints(name, url){
      try{
        const gj = await fetch(url).then(r=>r.json());
        const layer = L.geoJSON(gj, {
          pointToLayer: (f, latlng) => L.circleMarker(latlng,{radius:4,color:"#d33",weight:1,fillColor:"#f88",fillOpacity:0.8})
        }).addTo(map);
        vectorLayers.push(layer);
        overlays[name]=layer; layerControl.addOverlay(layer, name);
        try{ map.fitBounds(layer.getBounds()); }catch{}
      }catch(e){
        console.error("addPoints error", name, e);
      }
    }

    // --- preview CSV ---
    function fillSelectOptions(select, headers, preferred){
      select.innerHTML = "";
      headers.forEach(h=>{
        const opt = document.createElement("option");
        opt.value = h; opt.textContent = h;
        select.appendChild(opt);
      });
      const idx = headers.findIndex(h => h.toLowerCase() === preferred);
      if(idx>=0) select.selectedIndex = idx;
    }

    function renderPreviewTable(headers, rows){
      const tbl = document.getElementById("preview-table");
      tbl.innerHTML = "";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      headers.forEach(h=>{ const th=document.createElement("th"); th.textContent=h; trh.appendChild(th); });
      thead.appendChild(trh);
      const tbody = document.createElement("tbody");
      rows.slice(0,50).forEach(r=>{
        const tr = document.createElement("tr");
        headers.forEach(h=>{ const td=document.createElement("td"); td.textContent = r[h]; tr.appendChild(td); });
        tbody.appendChild(tr);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody);
      document.getElementById("preview-wrap").style.display="";
    }

    function currentSep(){
      const v = document.getElementById("sep").value;
      return v === "\\t" ? "\t" : v;
    }

    document.getElementById("preview").onclick = async () => {
      const f = document.getElementById("csvfile").files[0];
      if(!f){ alert("Selecciona un CSV"); return; }
      const sep = currentSep();
      Papa.parse(f, {
        delimiter: sep, header: true, dynamicTyping: false, preview: 200, skipEmptyLines: true,
        complete: res => {
          const data = res.data || [];
          if(!data.length){ alert("CSV vacío o separador incorrecto"); return; }
          const headers = res.meta.fields || Object.keys(data[0]);
          fillSelectOptions(document.getElementById("lon_field"), headers, "lon");
          fillSelectOptions(document.getElementById("lat_field"), headers, "lat");
          fillSelectOptions(document.getElementById("date_field"), headers, "date");
          fillSelectOptions(document.getElementById("id_field"), headers, "id");
          fillSelectOptions(document.getElementById("weight_field"), headers, "weight");
          fillSelectOptions(document.getElementById("case_field"), headers, "cases");
          renderPreviewTable(headers, data);
          const info = document.getElementById("preview-info");
          info.style.display=""; info.innerHTML = "";
          const chip = t => { const d=document.createElement("div"); d.className="chip"; d.textContent=t; return d; };
          info.appendChild(chip(`Filas (preview): ${data.length}`));
          info.appendChild(chip(`Separador: ${sep === "\t" ? "tab" : sep}`));
        }
      });
    };

    document.getElementById("process").onclick = async () => {
      const f = document.getElementById("csvfile").files[0];
      if(!f){ alert("Selecciona un CSV"); return; }

      const fd = new FormData();
      fd.append("csv_file", f);
      fd.append("grid", document.getElementById("grid").value || 12000);
      fd.append("cell", document.getElementById("cell").value || 1200);
      fd.append("contour", document.getElementById("contour").value || 30);
      fd.append("sep", document.getElementById("sep").value);
      fd.append("lon_field", document.getElementById("lon_field").value || "lon");
      fd.append("lat_field", document.getElementById("lat_field").value || "lat");
      fd.append("date_field", document.getElementById("date_field").value || "date");
      fd.append("id_field", document.getElementById("id_field").value || "id");
      fd.append("weight_field", document.getElementById("weight_field").value || "weight");
      fd.append("case_field", document.getElementById("case_field").value || "cases");

      const r = await fetch("/run", { method:"POST", body:fd });
      const js = await r.json();

      const ul = document.getElementById("downloads");
      ul.innerHTML="";
      for (const [k,v] of Object.entries(js.urls)) {
        if (v) {
          const li = document.createElement("li");
          li.innerHTML = `<a href="${v}" target="_blank" rel="noopener">${k}</a>`;
          ul.appendChild(li);
        }
      }

      renderVelocitySummary(js?.stats?.velocity);
      clearRasters(); clearVectors();
      if (js.urls.kriging)  await addRaster("kriging",  js.urls.kriging);
      if (js.urls.slope)    await addRaster("slope",    js.urls.slope);
      if (js.urls.velocity) await addRaster("velocity", js.urls.velocity);
      if (js.urls.selected_points_geojson) await addPoints("selected points", js.urls.selected_points_geojson);
    };
  </script>
</body>
</html>
